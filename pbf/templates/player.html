{% load static %}
<div id="spirit-image-{{player.id}}"
     class="content"
     hx-target="#spirit-image-{{player.id}}"
     hx-swap="outerHTML">
  <div class="spirit-image spirit-image{% if player.spirit.name == 'Covets' %}-double{% else %}-single{% endif %}">
    <div style="position: relative">
      {% for presence in player.presence_set.all %}
      <a style="cursor: pointer" hx-post="{% url 'toggle_presence' player.id presence.left presence.top %}">
	<img style="position: absolute; left: {{presence.left}}px; top: {{presence.top}}px; opacity: {{presence.opacity}}; z-index: 2" src="{% static player.disk_url %}" width="90" height="90" />
      </a>
      {% endfor %}
      {% if player.aspect %}
        {% if player.aspect == 'Encircle' %}
          <img style="position: absolute; left: 379px; top: 380px; height: 220px;width: 257px;" src="{% static 'pbf/aspect-encircle2.jpg' %}" />
          <img style="position: absolute; left: 23px; top: 461px; height: 50px; width: 327px;" src="{% static 'pbf/aspect-encircle1.jpg' %}" />
	{% elif player.aspect == 'Enticing' %}
          <img style="position: absolute; left: 655px; top: 380px; height: 220px;width: 281px;" src="{% static 'pbf/aspect-enticing.jpg' %}" />
	{% elif player.aspect == 'Haven' %}
          <img style="position: absolute; left: 380px; top: 380px; height: 220px;width: 342px;" src="{% static 'pbf/aspect-haven.jpg' %}" />
	{% elif player.aspect == 'Intensify' %}
          <img style="position: absolute; left: 22px; top: 467px; height: 159px;width: 352px;" src="{% static 'pbf/aspect-intensify.jpg' %}" />
	{% elif player.aspect == 'Lair' %}
          <img style="position: absolute; left: 379px; top: 373px; height: 231px;width: 281px;" src="{% static 'pbf/aspect-lair2.jpg' %}" />
          <img style="position: absolute; left: 15px; top: 551px; height: 72px; width: 359px;" src="{% static 'pbf/aspect-lair1.jpg' %}" />
	{% elif player.aspect == 'Mentor' %}
          <img style="position: absolute; left: 662px; top: 368px; height: 240px;width: 270px;" src="{% static 'pbf/aspect-mentor2.jpg' %}" />
          <img style="position: absolute; left: 15px; top: 420px; height: 59px; width: 360px;" src="{% static 'pbf/aspect-mentor1.jpg' %}" />
	{% elif player.aspect == 'Regrowth' %}
          <img style="position: absolute; left: 662px; top: 368px; height: 240px;width: 270px;" src="{% static 'pbf/aspect-regrowth2.jpg' %}" />
          <img style="position: absolute; left: 15px; top: 532px; height: 78px; width: 360px;" src="{% static 'pbf/aspect-regrowth1.jpg' %}" />
	{% elif player.aspect == 'Sparking' %}
          <img style="position: absolute; left: 374px; top: 379px; height: 224px;width: 352px;" src="{% static 'pbf/aspect-sparking.jpg' %}" />
	{% elif player.aspect == 'Spreading Hostility' %}
          <img style="position: absolute; left: 772px; top: 39px; height: 85px;width: 181px;" src="{% static 'pbf/aspect-spreading_hostility2.jpg' %}" />
          <img style="position: absolute; left: 15px; top: 400px; height: 78px; width: 360px;" src="{% static 'pbf/aspect-spreading_hostility1.jpg' %}" />
	{% elif player.aspect == 'Stranded' %}
          <img style="position: absolute; left: 15px; top: 460px; height: 69px;width: 352px;" src="{% static 'pbf/aspect-stranded.jpg' %}" />
	{% elif player.aspect == 'Tactician' %}
          <img style="position: absolute; left: 780px; top: 26px; height: 100px;width: 153px;" src="{% static 'pbf/aspect-tactician.jpg' %}" />
	{% elif player.aspect == 'Tangles' %}
          <img style="position: absolute; left: 378px; top: 380px; height: 212px;width: 274px;" src="{% static 'pbf/aspect-tangles.jpg' %}" />
	{% elif player.aspect == 'Transforming' %}
          <img style="position: absolute; left: 660px; top: 366px; height: 212px;width: 274px;" src="{% static 'pbf/aspect-transforming.jpg' %}" />
	{% elif player.aspect == 'Unconstrained' %}
          <img style="position: absolute; left: 23px; top: 517px; height: 93px;width: 350px;" src="{% static 'pbf/aspect-unconstrained.jpg' %}" />
          <img style="position: absolute; left: 545px; top: 399px; width: 86px;" src="{% static 'pbf/aspect-unconstrained-any.jpg' %}" />
	{% elif player.aspect == 'Violence' %}
          <img style="position: absolute; left: 379px; top: 384px; height: 226px;width: 277px;" src="{% static 'pbf/aspect-violence.jpg' %}" />
	{% elif player.aspect == 'Warrior' %}
          <img style="position: absolute; left: 646px; top: 356px; height: 226px;width: 277px;" src="{% static 'pbf/aspect-warrior.jpg' %}" />
	{% elif player.aspect == 'Deeps' %}
          <img style="position: absolute; left: 657px; top: 423px; height: 179px;width: 277px;" src="{% static 'pbf/aspect-deeps1.jpg' %}" />
          <img style="position: absolute; left: 379px; top: 430px; height: 179px;width: 277px;" src="{% static 'pbf/aspect-deeps2.jpg' %}" />
	{% elif player.aspect == 'Locus' %}
          <img style="position: absolute; left: 15px; top: 142px; height: 217px;width: 338px;" src="{% static 'pbf/aspect-locus1.jpg' %}" />
          <img style="position: absolute; left: 379px; top: 380px; height: 235px;width: 277px;" src="{% static 'pbf/aspect-locus2.jpg' %}" />
	{% elif player.aspect == 'Round Down' %}
          <img style="position: absolute; left: 10px; top: 470px; height: 40px;width: 338px;" src="{% static 'pbf/aspect-round_down.jpg' %}" />
	{% elif player.aspect == 'Exploratory' %}
    {% if player.spirit.name == 'Bringer' %}
      <img style="position: absolute; left: 450px; top: 255px; height: 95px" src="{% static 'pbf/exploratory-bringer-cardplays.jpg' %}" />
    {% elif player.spirit.name == 'Shadows' %}
      <img style="position: absolute; left: 387px; top: 159px; height: 85px" src="{% static 'pbf/exploratory-shadows-energy.jpg' %}" />
      <img style="position: absolute; left: 588px; top: 254px; width: 72px" src="{% static 'pbf/exploratory-shadows-reclaim1.jpg' %}" />
    {% endif %}
	{% elif player.spirit.name == 'Covets' %}
    {# Do nothing! The aspect is handled at the img level #}
        {% else %}
          <img style="position: absolute; left: {{player.aspect_left}}px; top: {{player.aspect_top}}px;" src="{% static player.aspect_url %}" width="370" height="230" />
        {% endif %}
      {% endif %}
      {% if player.spirit.name == 'Waters' %}
	{% for card in player.healing.all %}
	  {% if card.name == 'Waters Renew' %}
            <img style="position: absolute; left: 650px; top: 350px; clip-path: inset(70px 20px 110px 20px);" src="{% static card.url %}" width="320" height="380" />
	  {% elif card.name == 'Waters Taste of Ruin' %}
            <img style="position: absolute; left: 350px; top: 350px; clip-path: inset(70px 20px 110px 20px);" src="{% static card.url %}" width="320" height="380" />
	  {% else %}
            <img style="position: absolute; left: 10px; top: 10px;" src="{% static card.url %}" width="260" height="350" />
	  {% endif %}
	{% endfor %}
      {% endif %}
      {% for threshold in player.thresholds %}
      <img style="position: absolute; left: {{threshold.x}}px; top: {{threshold.y}}px;" src="{% if threshold.achieved %}{% static "pbf/green.svg" %}{% else %}{% static "pbf/red.svg" %}{% endif %}" width="20" height="20" />
      {% endfor %}
      {% if player.spirit.name == "Covets" %}
      {# We must not allow arbitrary aspect name to be interpolated into the path! Only allow known-good aspects. #}
      {% if player.aspect == 'v1.2.1' %}
      <img src="{% static 'pbf/covets_v1.2.1.jpg' %}" width="957" height="1260" />
      {% else %}
      <img src="{% static player.spirit.url %}" width="957" height="1260" />
      {% endif %}
      {% else %}
      <img src="{% static player.spirit.url %}" width="957" height="630" />
      {% endif %}
    </div>
  </div>

  {% if player.ready %}
  <button class="btn"
	  style="background-color: #8a8;"
	  hx-get="{% url 'discard_all' player.id %}">Ready! Click to Discard All Played and Unready</button>
  {% else %}
  <button class="btn"
	  hx-get="{% url 'ready' player.id %}"
	  style="background-color: #a88;"
	  >Not Ready</button>
  {% endif %}

  <br/>

  {% include "elements.html" %}
  {% include "energy_and_spirit_resource.html" %}

  {% with selection=player.selection_with_thresholds %}
  {% if selection %}
  <p>
  <h4>Selection:</h4>
  <ul>
    <div class="container-fluid">
      <div class="row">
	{% for card in selection %}
	<div class="col-auto">
	  <div class="w-100 w-md-200 mw-full">
	    <div class="card p-0 m-5 m-md-10">
	      <div style="position: relative">
		{% for threshold in card.computed_thresholds %}
		<img class="card-thresh" style="left: {{threshold.x}}%; top: {{threshold.y}}%" src="{% if threshold.achieved %}{% static "pbf/green.svg" %}{% else %}{% static "pbf/red.svg" %}{% endif %}" />
		{% endfor %}
		<img src="{% static card.url %}" class="img-fluid rounded-top" alt="{{card.name}}">
	      </div>
	      <div class="text-center pb-5">
		<button class="btn" hx-get="{% url 'choose_card' player.id card.id %}">Choose</button>
		{% if player.spirit.name == 'Fractured' %}
		<button class="btn" hx-get="{% url 'send_days' player.id card.id %}">Send to Days</button>
		{% endif %}
	      </div>
	    </div>
	  </div>
	</div>
	{% endfor %}
      </div>
    </div>
  </ul>
  <button class="btn" hx-get="{% url 'undo_gain_card' player.id %}" hx-confirm="Are you sure?">Oops! Undo gain card</button>

  <p>Minor powers ({{ player.game.minor_deck.count }} in deck):
  <button class="btn" hx-get="{% url 'minor_deck' player.game.id %}" hx-target="#Minor-deck" hx-swap="innerHTML">Show deck</button>
  <div id="Minor-deck"></div>
  <p>Major powers ({{ player.game.major_deck.count }} in deck):
  <button class="btn" hx-get="{% url 'major_deck' player.game.id %}" hx-target="#Major-deck" hx-swap="innerHTML">Show deck</button>
  <div id="Major-deck"></div>

  {% else %}
  <span hx-include="[name='spoiler_power_gain']">
  <p>Gain Minor ({{ player.game.minor_deck.count }} in deck):
  {% if player.aspect == 'Mentor' %}
  <button class="btn" hx-get="{% url 'take_powers' player.id 'minor' '2' %}">2 Cards (keep 2)</button>
  <button class="btn" hx-get="{% url 'gain_power' player.id 'minor' '4' %}" hx-confirm="Confirm you want to look at 4 minor power cards and keep 3 (Starlight Seeks Its Form used Boon of Reimagining on you)?">4 Cards (keep 3)</button>
  {% else %}
  <button class="btn" hx-get="{% url 'gain_power' player.id 'minor' '4' %}">4 Cards</button>
  <button class="btn" hx-get="{% url 'gain_power' player.id 'minor' '6' %}">6 Cards</button>
  {% endif %}
  <button class="btn" hx-get="{% url 'take_powers' player.id 'minor' '1' %}">1 Card</button>

  <button class="btn" hx-get="{% url 'minor_deck' player.game.id %}" hx-target="#Minor-deck" hx-swap="innerHTML">Show deck</button>

  <button class="btn" onClick="const ts = document.getElementById('trans-sac').style; ts.display = ts.display == 'block' ? 'none' : 'block'">Trans. Sac.</button>
  <div id="trans-sac" style="display: none">
    Transformative Sacrifice:
    <button class="btn" hx-get="{% url 'take_powers' player.id 'minor' '2' %}">Take 2</button>
    <button class="btn" hx-get="{% url 'take_powers' player.id 'minor' '3' %}">Take 3</button>
    <button class="btn" hx-get="{% url 'take_powers' player.id 'minor' '4' %}">Take 4</button>
  </div>

  <div id="Minor-deck"></div>

  <p>Gain Major ({{ player.game.major_deck.count }} in deck):
  {% if player.aspect == 'Mentor' %}
  <button class="btn" hx-get="{% url 'take_powers' player.id 'major' '2' %}">2 Cards (keep 2)</button>
  <button class="btn" hx-get="{% url 'gain_power' player.id 'major' '4' %}" hx-confirm="Confirm you want to look at 4 major power cards and keep 1 (event Visions Out of Time)?">4 Cards</button>
  {% else %}
  <button class="btn" hx-get="{% url 'gain_power' player.id 'major' '4' %}">4 Cards</button>
  {% if player.spirit.name == 'Covets' %}
  {% if player.aspect == 'v1.2.1' %}
  <button class="btn" hx-get="{% url 'gain_power' player.id 'major' '6' %}">6 Cards</button>
  {% elif player.aspect >= 'v1.3' %}
  <button class="btn" hx-get="{% url 'take_powers' player.id 'major' '3' %}">Take 3</button>
  {% endif %}
  {% endif %}
  <button class="btn" hx-get="{% url 'gain_power' player.id 'major' '2' %}">2 Cards</button>
  {% endif %}
  <button class="btn" hx-get="{% url 'take_powers' player.id 'major' '1' %}">1 Card</button>

  <button class="btn" hx-get="{% url 'major_deck' player.game.id %}" hx-target="#Major-deck" hx-swap="innerHTML">Show deck</button>
  <div id="Major-deck"></div>

  <p>
    <input type="checkbox" id="spoiler_power_gain" name="spoiler_power_gain" />
    <label for="spoiler_power_gain"><span title="Useful for gaining a power in the fast or slow phase while another player hasn't locked decisions from an earlier phase (growth or invader respectively)">Spoiler power gain (?)</span></label>
  </p>
  </span>

  {% if player.spirit.name == 'Waters' %}
  <p>Gain Healing Card: <button class="btn" hx-get="{% url 'gain_healing' player.id %}">Gain Healing Card</button>
  {% endif %}
  {% endif %}

  {% if taken_cards %}
  <div id="taken_cards">
    You took {{ taken_cards | length }} card{{ taken_cards | pluralize }}:
    <div class="container-fluid">
      <div class="row">
        {% for card in taken_cards %}
          <div class="col-auto">
            <div class="w-md-150">
              <img src="{% static card.url %}" class="img-fluid rounded-top" alt="{{card.name}}">
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
    <button class="btn" onClick="document.getElementById('taken_cards').remove();">OK (dismiss)</button>
  </div>
  {% endif %}
  {% endwith %}

  <p>
  <h4>Play/Hand:</h4>
  <ul>
    <div class="container-fluid">
      <div class="row">
	{% for card in player.played_cards_with_thresholds %}
	<div class="col-auto">
	  <div class="w-100 w-md-200 mw-full">
	    <div class="card p-0 m-5 m-md-10" style="background-color: #040;">
	      <div style="position: relative">

		{% for threshold in card.computed_thresholds %}
		<img class="card-thresh" style="left: {{threshold.x}}%; top: {{threshold.y}}%" src="{% if threshold.achieved %}{% static "pbf/green.svg" %}{% else %}{% static "pbf/red.svg" %}{% endif %}" />
		{% endfor %}

		<img src="{% static card.url %}" class="img-fluid rounded-top" alt="{{card.name}}">
	      </div>
	      <div class="text-center pb-5">
		<button class="btn" hx-get="{% url 'unplay_card' player.id card.id %}">Unplay</button>
		<button class="btn" hx-get="{% url 'discard_card' player.id card.id %}">Discard</button>
		<button class="btn" hx-get="{% url 'forget_card' player.id card.id %}" hx-confirm="Are you sure?">Forget</button>
		{% if 'Bargain' in card.name %}<button class="btn" hx-target="#spirit-energy{% if player.spirit_specific_resource_gives_energy %}-and-resource{% endif %}-{{player.id}}" hx-get="{% url 'change_bargain_cost_per_turn' player.id '1' %}">+Debt</button>{% endif %}
	      </div>
	    </div>
	  </div>
	</div>
	{% endfor %}
	{% for card in player.hand_cards_with_thresholds %}
	<div class="col-auto">
	  <div class="w-100 w-md-200 mw-full">
	    <div class="card p-0 m-5 m-md-10">
	      <div style="position: relative">

		{% for threshold in card.computed_thresholds %}
		<img class="card-thresh" style="left: {{threshold.x}}%; top: {{threshold.y}}%" src="{% if threshold.achieved %}{% static "pbf/green.svg" %}{% else %}{% static "pbf/red.svg" %}{% endif %}" />
		{% endfor %}

		<img src="{% static card.url %}" class="img-fluid rounded-top" alt="{{card.name}}">
	      </div>
	      <div class="text-center pb-5">
		<button class="btn" hx-get="{% url 'play_card' player.id card.id %}">Play</button>
		{% if player.spirit.name == 'Earthquakes' %}
		<button class="btn" hx-get="{% url 'impend_card' player.id card.id %}">Impend</button>
		{% endif %}
		<button class="btn" hx-get="{% url 'discard_card' player.id card.id %}">Discard</button>
		<button class="btn" hx-get="{% url 'forget_card' player.id card.id %}" hx-confirm="Are you sure?">Forget</button>
	      </div>
	    </div>
	  </div>
	</div>
	{% endfor %}
      </div>
    </div>
  </ul>

  {% if player.spirit.name == 'Earthquakes' %}
  <p>
  <h4>Impending:</h4>

    {% if player.spirit_specific_incremented_this_turn %}
      Gained all this turn!
    {% else %}
      <button class="btn" hx-get="{% url 'gain_energy_on_impending' player.id %}">+{{player.impending_energy}} to all cards made impending on previous turns</button>
    {% endif %}

  <ul>
    <div class="container-fluid">
      <div class="row">
	{% for i in player.impending_with_thresholds %}
	<div class="col-auto">
	  <div class="w-100 w-md-200 mw-full">
	    <div class="card p-0 m-5 m-md-10" {% if i.in_play %}style="background-color: #040;"{% endif %}>
	      <div style="position: relative">

		{% for threshold in i.card.computed_thresholds %}
		<img class="card-thresh" style="left: {{threshold.x}}%; top: {{threshold.y}}%" src="{% if threshold.achieved %}{% static "pbf/green.svg" %}{% else %}{% static "pbf/red.svg" %}{% endif %}" />
		{% endfor %}

		<img src="{% static i.card.url %}" class="img-fluid rounded-top" alt="{{i.card.name}}">
	      </div>
	      <div class="text-center pb-5">
		    <button class="btn" hx-get="{% url 'add_energy_to_impending' player.id i.card.id %}" {% if i.in_play or i.energy >= i.cost_with_scenario %}disabled{% endif %}>+1</button>
			{% if i.energy >= i.cost_with_scenario %}
				{% if i.in_play %}
					<button class="btn" hx-get="{% url 'unplay_from_impending' player.id i.card.id %}">Unplay</button>
					{# No check of spirit_specific_resource_gives_energy since Dances Up Earthquakes doesn't have a spirit-specific resource #}
					{% if 'Bargain' in i.card.name %}<button class="btn" hx-target="#spirit-energy-{{player.id}}" hx-get="{% url 'change_bargain_cost_per_turn' player.id '1' %}">+Debt</button>{% endif %}
				{% else %}
		   			<button class="btn" hx-get="{% url 'play_from_impending' player.id i.card.id %}">Play</button>
				{% endif %}
			{% else %}
				<button class="btn" disabled>{{ i.energy }} / {{ i.cost_with_scenario }}</button>
			{% endif %}
		    <button class="btn" hx-get="{% url 'remove_energy_from_impending' player.id i.card.id %}" {% if i.in_play or i.energy <= 0 %}disabled{% endif %}>-1</button>
	      </div>
	      <div class="text-center pb-5">
		    <button class="btn" hx-get="{% url 'unimpend_card' player.id i.card.id %}">Unimpend</button>
		    <button class="btn" hx-get="{% url 'forget_card' player.id i.card.id %}" hx-confirm="Are you sure?">Forget</button>
	      </div>
	    </div>
	  </div>
	</div>
	{% endfor %}
      </div>
    </div>

  </ul>
  {% endif %}

  <p>
  <h4>Discard:</h4>
  <ul>
    {% if player.discard.count > 0 %}
    <button class="btn" hx-get="{% url 'reclaim_all' player.id %}">Reclaim All</button>
    {% if player.spirit.name == 'Behemoth' %}<button class="btn" hx-get="{% url 'reclaim_all' player.id 'fire' %}">Reclaim All with Fire</button>{% endif %}
    {% endif %}


    <div class="container-fluid">
      <div class="row">
	{% for card in player.discard.all %}
	<div class="col-auto">
	  <div class="w-100 w-md-200 mw-full">
	    <div class="card p-0 m-5 m-md-10">
	      <img src="{% static card.url %}" class="img-fluid rounded-top" alt="{{card.name}}">
	      <div class="text-center pb-5">
		<button class="btn" hx-get="{% url 'reclaim_card' player.id card.id %}">Reclaim</button>
		<button class="btn" hx-get="{% url 'forget_card' player.id card.id %}" hx-confirm="Are you sure?">Forget</button>
	      </div>
	    </div>
	  </div>
	</div>
	{% endfor %}
      </div>
    </div>

  </ul>

  {% if player.spirit.name == 'Fractured' %}
  <p>
  <h4>Days That Never Were:</h4>
  <ul>
    <div class="container-fluid">
      <div class="row">
	{% for card in player.days_ordered.all %}
	<div class="col-auto">
	  <div class="w-100 w-md-200 mw-full">
	    <div class="card p-0 m-5 m-md-10">
	      <img src="{% static card.url %}" class="img-fluid rounded-top" alt="{{card.name}}">
	      <div class="text-center pb-5">
		<button class="btn" hx-get="{% url 'choose_days' player.id card.id %}">Gain</button>
	      </div>
	    </div>
	  </div>
	</div>
	{% empty %}
	<button class="btn" hx-get="{% url 'create_days' player.id 6 %}">Create Days (1 or 2 player game)</button><br>
	<button class="btn" hx-get="{% url 'create_days' player.id 4 %}">Create Days (3+ player game)</button>
	{% endfor %}
      </div>
    </div>

  </ul>
  {% endif %}

  <div id="spirit-discard-deck-{{player.id}}"
       hx-target="#spirit-discard-deck-{{player.id}}"
       hx-swap="outerHTML">
    <button class="btn" hx-get="{% url 'discard_pile' player.id %}">Show Power Discard Pile</button>
  </div>

  <p>
  Direct link to spirit:
  <a href="{% if player.aspect %}{% url 'view_game' player.game.id player.aspect %}{% else %}{% url 'view_game' player.game.id player.spirit.name %}{% endif %}">by spirit</a>
  {% if player.name %}
  <a href="{% url 'view_game' player.game.id player.name %}">by player name</a>
  {% endif %}
  <a href="{% url 'view_game' player.game.id player.id %}">by ID</a>
  </p>

</div>
